# Claude Code Monitoring

A comprehensive Docker-based monitoring stack for tracking Claude Code usage metrics using OpenTelemetry, Prometheus, and Grafana.

![Dashboard Screenshot](dashboard.png)

## Overview

This project provides a complete observability solution for monitoring your Claude Code CLI usage, including:

- **Cost tracking** - Monitor spending per model with hourly rates
- **Token usage** - Track input, output, cache read, and cache creation tokens
- **Cache efficiency** - Monitor cache hit rates to optimize costs
- **Model breakdown** - Compare usage across Opus, Sonnet, and Haiku
- **User analytics** - Track cost and usage per user
- **Time-based filtering** - Analyze data across flexible time ranges

## Architecture

```
Claude Code (CLI)
    │
    │ OTLP (gRPC :4317)
    ▼
┌─────────────────────┐
│ OpenTelemetry       │
│ Collector           │──► Prometheus (:9090) ──► Grafana (:3030)
└─────────────────────┘
```

## Quick Start

### Prerequisites

- Docker & Docker Compose
- Claude Code CLI installed

### 1. Clone and Configure

```bash
git clone https://github.com/rommelporras/claude-code-monitoring.git
cd claude-code-monitoring

# Copy and customize environment variables (optional)
cp .env.example .env
# Edit .env to change ports, credentials, etc.

# Start the stack
docker compose up -d
```

### 2. Configure Claude Code Telemetry

Add to your shell profile (`~/.bashrc`, `~/.zshrc`, etc.):

```bash
# Claude Code Telemetry (OpenTelemetry)
export CLAUDE_CODE_ENABLE_TELEMETRY=1
export OTEL_METRICS_EXPORTER=otlp
export OTEL_LOGS_EXPORTER=otlp
export OTEL_EXPORTER_OTLP_PROTOCOL=grpc
export OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317
export OTEL_METRIC_EXPORT_INTERVAL=10000  # 10s for testing, 60000 for production
```

Then reload your shell:

```bash
source ~/.zshrc  # or ~/.bashrc
```

### 3. Access Dashboards

| Service | URL | Credentials |
|---------|-----|-------------|
| Grafana | http://localhost:3030 | admin / admin |
| Prometheus | http://localhost:9090 | none |

### 4. Start Using Claude Code

Start a Claude Code session in a new terminal. Metrics will begin flowing within 10-30 seconds.

## Dashboard Features

The pre-built Grafana dashboard includes:

### Overview (Row 1)
- **Cost (30 Days)** - Total spending over last 30 days
- **Cost (Range)** - Spending within selected time range
- **Cost/Hour** - Average hourly spending rate
- **Cost per 1k Tokens** - Efficiency metric
- **Sessions** - Active sessions in time range
- **Active Users** - Unique users in time range
- **Tokens (30 Days)** - Total tokens over 30 days

### Efficiency & Token Details (Row 2)
- **Cache Hit Rate** - Percentage of tokens served from cache (target: >80%)
- **Input Tokens** - Tokens sent to the API
- **Output Tokens** - Tokens generated by Claude
- **Cache Read** - Tokens served from cache (saves money!)
- **Cache Creation** - Tokens used to create cache entries

### Model Breakdown (Row 3)
- **Cost by Model** - Compare spending across Opus, Sonnet, Haiku
- **Tokens by Model** - Token usage per model
- **Token Breakdown** - Pie chart of token types

### Trends (Row 4)
- **Cost Rate** - Spending rate over time ($/hour)
- **Token Rate** - Token usage rate over time (tokens/hour)

### User Details (Row 5)
- **Cost by User** - Table showing per-user spending with visual gauges

All panels (except the 30-day totals) respond to Grafana's time picker, allowing you to analyze:
- Last 1 hour
- Last 6 hours
- Last 24 hours
- Last 7 days
- Custom ranges

## Available Metrics

### Reliable Metrics (Currently Used)

| Metric | Labels | Description |
|--------|--------|-------------|
| `claude_code_cost_usage_USD_total` | `model`, `session_id`, `user_id` | Cost in USD per session |
| `claude_code_token_usage_tokens_total` | `model`, `type`, `session_id`, `user_id` | Token usage by type (input/output/cacheRead/cacheCreation) |
| `claude_code_active_time_seconds_total` | `type`, `session_id`, `user_id` | Active time in seconds (cli/user) |

**Important:** These are **per-session counters**. When a session ends, its time series becomes stale and is excluded from instant queries. Always use `increase()` or `rate()` functions for accurate aggregation.

### Known Limitations

The following metrics are **unreliable** or **not emitted** by Claude Code:

| Metric | Issue |
|--------|-------|
| `claude_code_lines_of_code_count_total` | Only counts Edit tool diffs, not Write operations |
| `claude_code_code_edit_tool_decision_total` | Doesn't count all edit decisions |
| `claude_code_commit_count_total` | Not emitted by Claude Code |
| `claude_code_pull_request_count_total` | Not emitted by Claude Code |
| `claude_code_session_count_total` | Not emitted (derived via `count by (session_id)`) |

These metrics have been removed from the dashboard to avoid confusion.

## Project Structure

```
claude-monitoring/
├── .env                            # Your local configuration (git-ignored)
├── .env.example                    # Example configuration template
├── docker-compose.yml              # Docker orchestration
├── otel-collector-config.yaml      # OpenTelemetry collector config
├── prometheus.yml                  # Prometheus scrape config
├── grafana/
│   └── provisioning/
│       ├── datasources/
│       │   └── datasource.yml      # Prometheus datasource
│       └── dashboards/
│           ├── dashboard.yml       # Dashboard provisioning
│           └── claude-code-dashboard.json  # Pre-built dashboard
├── start.sh                        # Convenience script for managing the stack
├── LICENSE                         # MIT License
├── CHANGELOG.md                    # Version history
└── README.md                       # This file
```

## Docker Services

| Service | Container Name | Ports | Purpose |
|---------|---------------|-------|------------|
| OpenTelemetry Collector | `claude-otel-collector` | 4317 (gRPC), 4318 (HTTP), 8889 | Receives metrics from Claude Code |
| Prometheus | `claude-prometheus` | 9090 | Time-series database |
| Grafana | `claude-grafana` | 3030 | Visualization dashboards |

## Management Commands

### Using the start.sh Script (Recommended)

A convenience script is provided for common operations:

```bash
# Start all containers
./start.sh

# Check status and health
./start.sh status

# View logs (Ctrl+C to exit)
./start.sh logs

# Stop all containers
./start.sh stop

# Restart all containers
./start.sh restart
```

The `status` command checks both container state and service health via HTTP endpoints.

### Using Docker Compose Directly

```bash
# Start the stack
docker compose up -d

# Stop the stack
docker compose down

# View logs
docker compose logs -f

# View specific service logs
docker compose logs -f claude-otel-collector
docker compose logs -f claude-prometheus
docker compose logs -f claude-grafana

# Restart a service
docker compose restart claude-grafana

# Stop and remove all data (WARNING: deletes all metrics)
docker compose down -v
```

## Auto-Start Configuration

### Automatic Container Restart

All containers are configured with `restart: unless-stopped` in docker-compose.yml. This means:

- **Containers auto-restart** if they crash or encounter errors
- **Containers auto-start** when Docker Desktop starts (Windows/Mac/WSL)
- **Containers stay stopped** only if you explicitly stop them with `docker compose stop`

### Windows + WSL Setup

If you're running Docker Desktop on Windows with WSL2 backend:

1. **Enable Docker Desktop integration** with your WSL distro:
   - Open Docker Desktop
   - Go to Settings → Resources → WSL Integration
   - Enable integration for your distro (e.g., Ubuntu)

2. **Start containers once** in WSL:
   ```bash
   cd ~/claude-monitoring  # or wherever you cloned this repo
   docker compose up -d
   ```

3. **Containers will auto-start** whenever:
   - Windows boots up
   - Docker Desktop starts
   - WSL restarts

### Verifying Auto-Start

Check that containers restarted automatically:

```bash
./start.sh status
# or
docker compose ps
```

Look for containers that show "Up X minutes" - if Docker was restarted recently, this uptime will be short.

### Troubleshooting Auto-Start

If containers don't auto-start after Docker Desktop restarts:

1. Check Docker Desktop WSL integration settings
2. Verify restart policy:
   ```bash
   docker inspect claude-grafana | grep -A 3 RestartPolicy
   # Should show: "Name": "unless-stopped"
   ```
3. Check Docker logs:
   ```bash
   docker compose logs --tail=50
   ```
4. Manually restart:
   ```bash
   ./start.sh restart
   ```

## Configuration

All configuration is done via the `.env` file. Copy `.env.example` to `.env` and modify as needed:

```bash
cp .env.example .env
```

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `GRAFANA_PORT` | `3030` | Grafana web UI port |
| `GRAFANA_ADMIN_USER` | `admin` | Grafana admin username |
| `GRAFANA_ADMIN_PASSWORD` | `admin` | Grafana admin password (change in production!) |
| `PROMETHEUS_PORT` | `9090` | Prometheus web UI port |
| `PROMETHEUS_RETENTION` | `200h` | Data retention period (~8 days) |
| `OTEL_GRPC_PORT` | `4317` | OpenTelemetry gRPC port |
| `OTEL_HTTP_PORT` | `4318` | OpenTelemetry HTTP port |
| `OTEL_METRICS_PORT` | `8889` | Prometheus metrics export port |

### Example: Custom Ports

```bash
# .env
GRAFANA_PORT=8080
PROMETHEUS_PORT=9091
OTEL_GRPC_PORT=4320
```

After changing `.env`, restart the stack:

```bash
docker compose down
docker compose up -d
```

**Note:** If you change `OTEL_GRPC_PORT`, update your shell profile to match:

```bash
export OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4320  # Match your OTEL_GRPC_PORT
```

### Debug Mode

For more verbose OpenTelemetry output, check the collector logs:

```bash
docker compose logs -f claude-otel-collector
```

## Troubleshooting

### No metrics appearing in Grafana

1. Verify Claude Code telemetry is enabled:
   ```bash
   echo $CLAUDE_CODE_ENABLE_TELEMETRY
   # Should output: 1
   ```

2. Check the OTel collector is receiving data:
   ```bash
   docker compose logs -f claude-otel-collector
   # Look for: "ExportMetricsServiceRequest"
   ```

3. Verify Prometheus is scraping:
   - Open http://localhost:9090/targets
   - Check `claude-otel-collector` target is UP
   - Query `up{job="claude-otel-collector"}` should return 1

4. Verify metrics are being scraped:
   ```bash
   curl -s "http://localhost:9090/api/v1/query?query=claude_code_cost_usage_USD_total" | jq
   ```

5. Make sure you started Claude Code in a **new terminal** after configuring telemetry

### Metrics showing zero or "No data"

This is normal when:
- No Claude Code sessions are currently active
- The selected time range has no activity
- You just started the stack (wait 10-30 seconds)

### Dashboard shows wrong values

Common issues:
- **Time range too short:** Some panels need at least 5-10 minutes of data
- **Stale sessions:** Cost/token counters are per-session and reset when sessions end
- **Cache hit rate NaN:** Appears when no input tokens exist in the selected range

### Permission denied errors

Fix file permissions:

```bash
chmod 644 *.yml *.yaml
chmod 644 grafana/provisioning/*/*.yml grafana/provisioning/*/*.json
chmod 755 grafana grafana/provisioning grafana/provisioning/*
```

### Port already in use

Check what's using the port and either stop that service or change the port in `.env`:

```bash
lsof -i :3030  # or :9090, :4317, etc.
sudo lsof -i :3030  # if above returns nothing
```

### Data retention and disk space

Prometheus stores data in `prometheus_data/` volume. To manage storage:

```bash
# Check disk usage
docker system df -v | grep prometheus

# Reduce retention (edit .env)
PROMETHEUS_RETENTION=100h  # ~4 days

# Delete old data (WARNING: irreversible)
docker compose down
docker volume rm claude-monitoring_prometheus_data
docker compose up -d
```

## Advanced Configuration

### Custom Resource Attributes

Add team/department labels for multi-team tracking:

```bash
export OTEL_RESOURCE_ATTRIBUTES="department=engineering,team.id=platform"
```

These will appear as labels on your metrics for filtering.

### Separate Endpoints

Configure separate endpoints for metrics and logs:

```bash
export OTEL_EXPORTER_OTLP_METRICS_ENDPOINT=http://metrics.example.com:4317
export OTEL_EXPORTER_OTLP_LOGS_ENDPOINT=http://logs.example.com:4317
```

### Production Export Interval

For production, increase the export interval to reduce overhead:

```bash
export OTEL_METRIC_EXPORT_INTERVAL=60000  # 60 seconds
```

### Multiple Environments

Run separate monitoring stacks for dev/staging/prod:

```bash
# Terminal 1: Dev environment
cd claude-monitoring-dev
GRAFANA_PORT=3030 PROMETHEUS_PORT=9090 docker compose up -d

# Terminal 2: Prod environment
cd claude-monitoring-prod
GRAFANA_PORT=3031 PROMETHEUS_PORT=9091 OTEL_GRPC_PORT=4320 docker compose up -d
```

Configure each Claude Code instance to point to its respective collector.

## Query Examples

Useful PromQL queries for custom dashboards or alerts:

```promql
# Total cost in last 24 hours
sum(increase(claude_code_cost_usage_USD_total[24h]))

# Cost per model (last hour)
sum by (model) (increase(claude_code_cost_usage_USD_total[1h]))

# Average cost per hour (last 7 days)
sum(increase(claude_code_cost_usage_USD_total[7d])) / 168

# Cache hit rate (last 6 hours)
sum(increase(claude_code_token_usage_tokens_total{type="cacheRead"}[6h]))
/
(sum(increase(claude_code_token_usage_tokens_total{type="input"}[6h])) + sum(increase(claude_code_token_usage_tokens_total{type="cacheRead"}[6h])))
* 100

# Active users in last hour
count(count by (user_id) (increase(claude_code_cost_usage_USD_total[1h]) > 0))

# Top 5 most expensive users (last 24h)
topk(5, sum by (user_id) (increase(claude_code_cost_usage_USD_total[24h])))
```

## Cost Optimization Tips

Based on the dashboard metrics:

1. **Improve Cache Hit Rate**
   - Target: >80% cache hit rate
   - Use longer context in conversations
   - Reuse similar prompts across sessions
   - Monitor the Cache Hit Rate gauge

2. **Choose the Right Model**
   - Use Haiku for simple tasks (cheapest)
   - Use Sonnet for balanced performance
   - Use Opus only for complex reasoning
   - Check "Cost by Model" to identify optimization opportunities

3. **Monitor Hourly Spend**
   - Set a budget alert threshold
   - Watch "Cost/Hour" panel for spikes
   - Review "Cost (Range)" daily

4. **Track Per-User Costs**
   - Use "Cost by User" table to identify high spenders
   - Implement team budgets
   - Educate users on cost-effective practices

## Future Enhancements

Planned features:
- Visual threshold indicators for cost alerts
- Efficiency alerts (cache hit rate drops, cost spikes)
- Color-coded warnings for configurable thresholds
- Anomaly detection

## Resources

- [Claude Code Monitoring Guide](https://code.claude.com/docs/en/monitoring-usage) - Official telemetry documentation
- [Claude Code Documentation](https://docs.anthropic.com/en/docs/claude-code)
- [OpenTelemetry Documentation](https://opentelemetry.io/docs/)
- [Prometheus Query Language](https://prometheus.io/docs/prometheus/latest/querying/basics/)
- [Grafana Dashboards](https://grafana.com/docs/grafana/latest/dashboards/)

## Contributing

Contributions are welcome! Please:
1. Fork the repository
2. Create a feature branch
3. Test your changes with a real Claude Code setup
4. Submit a pull request

## Author

Created by [Rommel C. Porras](https://rommelporras.com)

## License

MIT

## Security Notes

**For Production Deployments:**

1. **Change default Grafana credentials** in `.env`:
   ```bash
   GRAFANA_ADMIN_PASSWORD=your-secure-password
   ```

2. **Use HTTPS** with a reverse proxy (nginx/Caddy)

3. **Restrict network access**:
   ```yaml
   # docker-compose.yml
   ports:
     - "127.0.0.1:3030:3030"  # Only localhost
   ```

4. **Enable authentication** on Prometheus (if exposed)

5. **Secure OTEL endpoint** if accepting remote connections

6. **Regular backups** of Grafana dashboards and Prometheus data

7. **Monitor disk usage** - Prometheus data grows over time
